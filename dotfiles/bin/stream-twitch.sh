#!/bin/bash

# originaly from http://tinyurl.com/twitch-linux from taladan
# www.youtube.com/user/taladan

# gist created by brodul

# http://forums.heroesofnewerth.com/showthread.php?229469-HOWTO-Streaming-in-Linux
INRES="1280x800"			# input resolution
INRES="3360x1050"			# input resolution
#OUTRES="1024x640"			# Output resolution
#OUTRES="1366x768"			# Output resolution
OUTRES="800x500"			# Output resolution
OUTRES="1680x525"			# Output resolution
OUTRES="1600x500"			# Output resolution
#OUTRES="3360x1050"			# output resolution
FPS="30"					# target FPS
QUAL="medium"					# one of the many FFMPEG preset on (k)ubuntu found in /usr/share/ffmpeg
#QUAL="fast"					# one of the many FFMPEG preset on (k)ubuntu found in /usr/share/ffmpeg
# If you have low bandwidth, put the qual preset on 'fast' (upload bandwidth)
# If you have medium bandwidth put it on normal to medium

# Write your key in a file named .twitch_key in your home directory
STREAM_KEY=$(cat ~/.twitch_key)   # This is your streamkey generated by jtv/twitch found at: http://www.justin.tv/broadcast/adv_other

RTMP="rtmp://live.justin.tv/app/${STREAM_KEY}";
RTMP="rtmp://live-iad-backup.justin.tv/app/${STREAM_KEY}";
echo $RTMP;
#exit

#	-vcodec libx264 -s $OUTRES -preset $QUAL \
#
#	-f pulse -ac 1 -i alsa_input.pci-0000_00_1b.0.analog-stereo \
#	-f pulse -ac 2 -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
#
#	-f pulse \
#		-i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
#		-i alsa_input.pci-0000_00_1b.0.analog-stereo \
#	-f flv "rtmp://live.justin.tv/app/$STREAM_KEY" \
#	-f flv "$RTMP" \
# loglevels: quiet panic fatal error warning info verbose debug
#avconv -loglevel info \
avconv \
	-f pulse -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
	-f pulse -i alsa_input.pci-0000_00_1b.0.analog-stereo \
	-f x11grab -s "$INRES" -r "$FPS" -i :0.0+0,0 \
	-filter_complex amix=inputs=2:duration=first:dropout_transition=3 \
	-vcodec libx264 -preset "$QUAL" -s $OUTRES \
	-acodec libmp3lame -ar 44100 -threads 6 -qscale 3 -b 712000 -bufsize 512k \
	-f flv "$RTMP" \
;

